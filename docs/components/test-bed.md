# ComponentTestBed

The `ComponentTestBed` significantly reduces the boilerplate required to perform component tests.

In addition, it provides the same utilities described in [element.md](element.md#element-query) and [event.md](event.md#event-triggering) but without the fixture parameter.

## Preview example

```ts
import { componentTestBed } from 'ngx-testing-tools';
import { AppComponent } from './app.component';
import { AppService } from './app.service';
import { InnerComponent } from './inner.component';

describe('AppComponent', () => {
  const tb = componentTestBed(AppComponent)
    .provide(AppService)
    .inject('service', AppService);

  tb.compileEach()
  tb.shouldCreate();

  it('should update `clicked` on button click', tb(({ component, action }) => {
    expect(component.clicked).toBeFalse();
    action.click('#my-button');
    expect(component.clicked).toBeTrue();
  }));

  it('should store in AppService when InnerComponent state is true', tb(({ query, fixture, injected: { service } }) => {
    const inner = query.findComponent(InnerComponent);
    inner.myState = true;

    fixture.detectChanges();

    expect(service.status).toBeEqual({ status: 'OK' });
  }));
});
```

## Table of contents

- [componentTestBed(…)](#componenttestbedrootcomponent)
- [ComponentTestBed](#componenttestbed-1)
  - [import(..)](#importoneormanyimports)
  - [declare(..)](#declareoneormanydeclarations)
  - [provide(..)](#provideoneormanyproviders)
  - [compileEach()](#compileeach)
  - [compile()](#compile)
  - [shouldCreate()](#shouldcreate)
  - [(..) (direct call)](#assertion-options)
  - [setup(..)](#setupaction)

## componentTestBed(rootComponent)

Returns the `ComponentTestBed` associated to the described component.

It will check that the provided `rootComponent` is definitely a component.

> The root component will be automatically being "imported" (standalone) or "declared" (not standalone) into testing module.

#### Parameters

- rootComponent
  - type: `Type<any>`.
  - description: the component to be described and from which the fixture will be created.

#### Examples

```ts
const tb = componentTestBed(AppComponent); // OK
```

```ts
const tb = componentTestBed(MyButtonDirective); // Not OK, throws an Error
```

## ComponentTestBed

Includes all the methods required to configure the test module and wrap every expectation functions.

### import(oneOrManyImports)

Imports required module(s) and standalone component(s) into testing module for your current tests.

Returns the current `ComponentTestBed` instance.

#### Parameters

- oneOrManyImports
  - type: `Type<any>` or `Type<any>[]`.
  - description: the module(s) or standalone component(s).

#### Example

```ts
describe('AppComponent', () => {
  const tb = componentTestBed(AppComponent)
    .import(SharedModule)
    .import([InnerComponent, MaterialModule]);
});
```

### declare(oneOrManyDeclarations)

Declares required non-standalone component(s), directive(s) and pipe(s) into testing module for your current tests.

Returns the current `ComponentTestBed` instance.

#### Parameters

- oneOrManyDeclarations
  - type: `Type<any>` or `Type<any>[]`.
  - description: the component(s), directive(s) and pipe(s) (non-standalone).

#### Example

```ts
describe('AppComponent', () => {
  const tb = componentTestBed(AppComponent)
    .declare(AppFirstComponent)
    .declare([AppSecondComponent, AppPipe]);
});
```

### provide(oneOrManyProviders)

Provides injectable service(s) or other(s) provider(s) required into testing module for your current tests.

Returns the current `ComponentTestBed` instance.

#### Parameters

- oneOrManyProviders
  - type: `Provider` or `EnvironmentProviders` or `(Provider | EnvironmentProviders)[]`.
  - description: the providers.

#### Example

```ts
describe('AppComponent', () => {
  const tb = componentTestBed(AppComponent)
    .provide(AppService)
    .provide([StoreService, { provide: MY_TOKEN, useValue: mockValue }]);
});
```

### compileEach()

Compiles the `ComponentTestBed` to be able to provide tools into `tb()`'s callback (see [below](#assertion-options)).

**It has to be used just after the `ComponentTestBed` creation.**

#### Usage

```ts
describe('AppComponent', () => {
  const tb = componentTestBed(AppComponent);
  tb.compileEach();
});
```

### compile()

Use it if you need to do extra setups before compiling the `ComponentTestBed`.

**It has to be used into `beforeEach()` setup.**

Returns a `Promise<void>`.

#### Usage

```ts
describe('AppComponent', () => {
  const tb = componentTestBed(AppComponent);

  beforeEach(() => {
    // (..) my extra setup
    return tb.compile();
  });
});
```

### shouldCreate()

Sets up the redondant "should create" test generated by Angular schematic.

**It must be used outside an `it` test.**

#### Usage

```ts
describe('AppComponent', () => {
  const tb = componentTestBed(AppComponent);
  tb.compileEach();
  tb.shouldCreate();
});
```

### inject(name, token)

Inject an instance by token into the `ComponentTestBed`.

Retrieve it into the `ComponentTools.injected` by autocompletion.

#### Parameters

- name
  - type: `string`.
  - description: the name of the injection.
- token
  - type: `TokenProvider<T>`.
  - description: the token provider.

#### Example

```ts
describe('AppComponent', () => {
  const tb = componentTestBed(AppComponent)
    .inject('auth', AuthService)
    .import(HttpClientTestingModule)
    .inject('httpc', HttpTestingController);

  tb.compileEach();
  
  it('should do something', tb(({ injected: { auth, httpc }}) => {
    // (…) expectations
  }));
});
```

### (assertion, options?)

Wraps the `it` assertion function and provides enhanced tools for testing component expectations.

It supports the jasmine `DoneFn` and `async`/`await` (check examples below).

It automatically starts the assertion by running `fixture.detectChanges()` (can be disabled, check options below).

#### Parameters

- assertion
  - type: `(tools: ComponentTools<T>, done: DoneFn) => (void | PromiseLike<any>)`.
  - description: the assertion function.

```ts
interface ComponentTools<T> {
  /**
   * The described component fixture.
   */
  fixture: ComponentFixture<T>;
  /**
   * The described component instance.
   */
  component: T;
  /**
   * The fixture injector.
   */
  injector: Injector;
  /**
   * Enhanced tools to query elements.
   */
  query: ComponentQueryTools;
  /**
   * Enhanced tools to perform action on elements.
   */
  action: ComponentActionTools;
  /**
   * Store from which we can retrieve injection instances created by the `inject()` function.
   */
  injected: { [name: string]: any };
}
```

- options?
  - type: `ComponentExtraOptions`.
  - description: the tb options.

```ts
interface ComponentExtraOptions {
  /**
   * Runs component fixture `detectChanges()` once before executing the assertion function.
   * @default true
   */
  startDetectChanges?: boolean;
}
```

#### Examples

```ts
it('should do something', tb(({ component, fixture, injector, action, query }) => {
  const inner = query.findComponent(InnerComponent);
  action.click('#my-button');

  const appService = injector.get(AppService);
  // (…) expectations
})); 
```

```ts
it('should do something', tb(({ component, fixture }, done) => {
  // (…) expectations
  done();
}, { startDetectChanges: false })); 
```

```ts
it('should do something', tb(async ({ component, fixture }) => {
  // (…) async expectations 
})); 
```

### setup(action)



#### Parameters

#### Example

```ts

```
